<!-- ✅ User Registration Form -->
<section id="user-register" class="bg-white shadow p-6 rounded-lg mb-10">
  <h2 class="text-lg font-bold mb-4">👤 Register as a Customer</h2>
  <form id="user-form" class="space-y-4">
    <input type="text" name="username" placeholder="Full Name" required class="border p-2 rounded w-full" />
    <input type="email" name="email" placeholder="Email Address" required class="border p-2 rounded w-full" />
    <input type="tel" name="phone" placeholder="WhatsApp Number" required class="border p-2 rounded w-full" />
    <input type="text" name="userAddress" placeholder="Current Address" id="user-location" readonly class="border p-2 rounded w-full bg-gray-100" />
    <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Register User</button>
    <p id="user-msg" class="text-sm mt-2 text-green-600 hidden">✅ Registration successful!</p>
  </form>
</section>

<!-- ✅ Business Registration Form -->
<section id="business-register" class="bg-white shadow p-6 rounded-lg mb-10">
  <h2 class="text-lg font-bold mb-4">🏢 Register Your Business</h2>
  <form id="business-form" class="space-y-4">
    <input type="text" name="businessName" placeholder="Business Name" required class="border p-2 rounded w-full" />
    <select name="category" id="category-dropdown" required class="border p-2 rounded w-full">
      <option value="">Select Business Category</option>
    </select>
    <input type="text" name="address" placeholder="Business Address" id="business-location" readonly class="border p-2 rounded w-full bg-gray-100" />
    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Register Business</button>
    <p id="biz-msg" class="text-sm mt-2 text-green-600 hidden">✅ Business registered successfully!</p>
  </form>
</section>

<!-- ✅ Scripts -->
<script>
  // Autofill location for both user & business
  function fillLocation(inputId) {
    if ("geolocation" in navigator) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const input = document.getElementById(inputId);
          if (input) {
            input.value = `Lat: ${position.coords.latitude}, Lng: ${position.coords.longitude}`;
          }
        },
        (err) => {
          alert("Location error: " + err.message);
        }
      );
    }
  }

  // Load business categories
  function loadCategories() {
    fetch('/.netlify/functions/list-businesses')
      .then(res => res.json())
      .then(data => {
        const categories = [...new Set(data.map(b => b.category))];
        const dropdown = document.getElementById("category-dropdown");
        if (dropdown) {
          categories.forEach(cat => {
            const opt = document.createElement("option");
            opt.value = cat;
            opt.textContent = cat;
            dropdown.appendChild(opt);
          });
        }
      })
      .catch(err => console.error("Failed to load categories", err));
  }

  document.addEventListener("DOMContentLoaded", () => {
    // Autofill location on load
    fillLocation("user-location");
    fillLocation("business-location");

    // Load business categories
    loadCategories();

    // Handle user registration
    const userForm = document.getElementById("user-form");
    if (userForm) {
      userForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const msg = document.getElementById("user-msg");
        if (msg) {
          msg.classList.remove("hidden");
          setTimeout(() => msg.classList.add("hidden"), 3000);
        }
      });
    }

    // Handle business registration
    const bizForm = document.getElementById("business-form");
    if (bizForm) {
      bizForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const data = {
          businessName: bizForm.businessName.value,
          category: bizForm.category.value,
          address: bizForm.address.value,
        };

        const res = await fetch("/.netlify/functions/register-business", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });

        const result = await res.json();
        if (res.ok) {
          const msg = document.getElementById("biz-msg");
          if (msg) {
            msg.classList.remove("hidden");
            setTimeout(() => msg.classList.add("hidden"), 3000);
          }
          bizForm.reset();
        } else {
          alert("❌ Error: " + (result.error || "Unknown error"));
        }
      });
    }
  });
</script>
